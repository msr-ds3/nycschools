---
title: "Map of Feeder Schools"
author: "Rivka and Ro"
date: "7/27/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(dplyr)
library(leaflet)
library(httr)
library(sp)
library(rgdal)
library(readr)
library(htmlwidgets)

```

## load files

```{r}

load("/data/nycdoe/clean_data/where_students_go_feeder_year.Rdata")
feeder_data <- where_students_go_feeder_data_year

#load lat lonngs and census tract for school
load("/data/nycdoe/school_info_with_lat_long.Rdata")

load("/data/nycdoe/clean_data/distance_students_commute_to_school.Rdata")

```

```{r}

#think about: computing distance for how for a student travels for schools

# number of closed schools = zero


# df to join later on dbn to add census tract for dbn and the school name
school_info_join <- school_info %>% 
  select(`ATS System Code`, `Location Name`, `Census Tract`)

# fix names of columns
school_info_join <- school_info_join %>% rename(ats_system_code = `ATS System Code`, location_name = `Location Name`, school_census_tract = `Census Tract`)

# change census tract to 6 digits
school_info_join <- school_info_join %>% 
  ungroup() %>% 
  mutate(school_census_tract = as.integer(school_census_tract))

school_info_join <- school_info_join %>%
  mutate(school_census_tract =  sprintf("%06d", school_census_tract))

school_info_join <- school_info_join %>%
  mutate(school_census_tract = as.character(school_census_tract))

# df with latitude and longitude for each school
schools_lat_long <- lat_long

# df for adding lat long of schools in map
marker_schools <- student_dbn_location %>% select(dbn, school_name, school_lat, school_lon) %>% distinct()

```


### data frames for middle school and high school
```{r}

mid_to_hs <- feeder_data %>% select(mid, hs, year, numStudents) %>% arrange(mid, year)

hs_to_mid <- feeder_data %>% select(hs, mid, year, numStudents) %>% arrange(hs, year)

```


### joining data frames for mapping
```{r}

# joining the lat long and school info dfs
lat_long_and_school_info <- inner_join(school_info_join, schools_lat_long, by = c("ats_system_code" = "dbn"))

# join above data frame (lat long for school) with mid to hs and hs to mid dfs

##### middle to high school (mapping what high schools students go to)
mid_to_hs <- inner_join(mid_to_hs, lat_long_and_school_info, by = c("hs" = "ats_system_code"))
##### high school to middle school (mapping what middle schools students come from)
hs_to_mid <- inner_join(hs_to_mid, lat_long_and_school_info, by =c("mid" = "ats_system_code"))

# to join on counties
counties <- student_dbn_location %>% select(dbn, school_county) %>% distinct()

# join county for each hs
mid_to_hs <- inner_join(mid_to_hs, counties, by = c("hs" = "dbn"))

mid_to_hs <- mid_to_hs %>% rename(hs_county = school_county)

#join county for each middle school
hs_to_mid <- inner_join(hs_to_mid, counties, by = c("mid" = "dbn"))

hs_to_mid <- hs_to_mid %>% rename(mid_county = school_county)

```

### mapping mid_to_hs and hs_to_mid to a map of census tracts
```{r}

# load nyc census tracts file = nyc_tracts
load("/data/nycdoe/nyc_tracts.Rdata")

# the below code concatenates the hs and location names for schools with the same census tract and county, by year
mid_to_hs_edit <- mid_to_hs %>% 
  group_by(year, mid, school_census_tract, hs_county) %>% 
  mutate(total_student_count = sum(numStudents), hs = paste(hs, collapse="; "), numStudents = paste(numStudents, collapse="; "), location_name = paste(location_name, collapse="; ")) 

# sample middle school map data
sample_ms_map_data <- mid_to_hs_edit %>% filter(mid == "10X368" & year == 2010) %>% 
  distinct(school_census_tract, .keep_all = TRUE)

# middle school map merge
ms_map <- merge(nyc_tracts, sample_ms_map_data, by.x=c("TRACTCE","COUNTYFP"), by.y = c("school_census_tract","hs_county"))

########### marker schools df ################

marker_schools_search <- marker_schools %>% filter(dbn == "10X368")

############ OLD CODE #########################
#sample_ms_map_data <- mid_to_hs %>% 
 # filter(mid == "10X368" & year == 2009)

#sample_ms_map_data_edit <- sample_ms_map_data %>% 
 # group_by(school_census_tract, hs_county, year) %>% 
#  mutate(total_student_count = sum(numStudents), hs = paste(hs, collapse=", "), numStudents = paste(numStudents, collapse=", "), location_name = paste(location_name, collapse=", ")) %>% distinct(school_census_tract, .keep_all = TRUE) 

############## END OLD CODE ############################



############# hs map data ####################


# the below code concatenates the middle school and location names for schools with the same census tract and county, by year
hs_to_mid_edit <- hs_to_mid %>% 
  group_by(year, hs, school_census_tract, mid_county) %>% 
  mutate(total_student_count = sum(numStudents), mid = paste(mid, collapse="; "), numStudents = paste(numStudents, collapse="; "), location_name = paste(location_name, collapse="; ")) 

# sample hs school map data
sample_hs_map_data <- hs_to_mid_edit %>% filter(hs == "10X368" & year == 2009) %>% 
  distinct(school_census_tract, .keep_all = TRUE)

# hs school map merge
hs_map <- merge(nyc_tracts, sample_hs_map_data, by.x=c("TRACTCE","COUNTYFP"), by.y = c("school_census_tract","mid_county"))


```

## school code icon
```{r}

school_icon <- makeIcon(
 iconUrl = "http://www.freeiconspng.com/uploads/high-school-icon-png-8.png",
 iconWidth = 38, iconHeight = 38)

```

## creating middle school map
## when a middle school is chosen, the map will show which census tract and which high schools students are going to
```{r}

#palette for plotting map
pal <- colorNumeric(palette = "Reds",
                    domain = range(ms_map@data$total_student_count, na.rm=T), na.color="#cccccc")

leaflet(ms_map) %>%
  #addTiles() %>% 
  addPolygons(weight = .5, color="blue", fillColor = ~pal(total_student_count), popup = ~paste("Number of Students:", numStudents, "</br>School Name:", location_name), fillOpacity = .7) %>% 
  addLegend(pal = pal, values = ~total_student_count, opacity = 1) %>%
  #addMarkers(~lon, ~lat, popup = ~as.factor(hs_dbn), label = ~location_name, icon = hs_school_icon) %>%
  addProviderTiles("CartoDB.Positron") %>%
  setView(-73.98, 40.75, zoom = 13)


```

#### function for creating map of mid to high ####

```{r}

 

######## Function for getting middle school and year ########


get_mid_to_hs_map <- function(middle_school, school_year) {
  
  # data fed into map
  sample_ms_map_data <- mid_to_hs_edit %>% filter(mid == middle_school & year == school_year) %>% 
  distinct(school_census_tract, .keep_all = TRUE)

  # marker school data
  marker_schools_search <- marker_schools %>% filter(dbn == middle_school)

  # merge spacial census tracts file with data
  ms_map <- merge(nyc_tracts, sample_ms_map_data, by.x=c("TRACTCE","COUNTYFP"), by.y = c("school_census_tract","hs_county"))
  
  #palette for map
  pal <- colorNumeric(palette = "Reds",
                    domain = range(ms_map@data$total_student_count, na.rm=T), na.color="#cccccc")
  
  # map
  leaflet(ms_map) %>%
    #addTiles() %>% 
    addPolygons(weight = .5, color="blue", fillColor = ~pal(total_student_count), popup = ~paste("Number of Students:", numStudents, "</br>School Name:", location_name), fillOpacity = .7, highlightOptions = highlightOptions(color = "white", weight = 3,
      bringToFront = TRUE)) %>% 
    addLegend(pal = pal, values = ~total_student_count, opacity = 1,
              title = "Distribution of the </br> high schools students</br> go to") %>%
    addMarkers(data = marker_schools_search, ~school_lon, ~school_lat, label = ~school_name, icon = school_icon) %>%
    addProviderTiles("CartoDB.Positron") %>%
    setView(marker_schools_search$school_lon, marker_schools_search$school_lat, zoom = 13)
  
}

get_mid_to_hs_map("10X368", 2009)


## saving main hs data frame
save(mid_to_hs_edit, file = "/data/nycdoe/clean_data/data_for_middle_to_high_feeder_map.Rdata")


```



#### function for creating map of high from mid ####

```{r}

######## Function for getting middle school and year ########

get_hs_from_mid_map <- function(high_school, school_year) {
  # data fed into map
  sample_hs_map_data <- hs_to_mid_edit %>% filter(hs == high_school & year == school_year) %>% 
  distinct(school_census_tract, .keep_all = TRUE)
  
  # marker school data
  marker_schools_search <- marker_schools %>% filter(dbn == high_school)

  # merge spacial census tracts file with data
  hs_map <- merge(nyc_tracts, sample_hs_map_data, by.x=c("TRACTCE","COUNTYFP"), by.y = c("school_census_tract","mid_county"))
  
  #palette for map
  pal <- colorNumeric(palette = "Reds",
                    domain = range(hs_map@data$total_student_count, na.rm=T), na.color="#cccccc")

  # map
  leaflet(hs_map) %>%
    #addTiles() %>% 
    addPolygons(weight = .5, color="blue", fillColor = ~pal(total_student_count), popup = ~paste("Number of Students:", numStudents, "</br>School Name:", location_name), fillOpacity = .7, highlightOptions = highlightOptions(color = "white", weight = 3,
      bringToFront = TRUE)) %>% 
    addLegend(pal = pal, values = ~total_student_count, opacity = 1,
              title = "Distribution of the </br> middle schools </br> students come from") %>%
    addMarkers(data = marker_schools_search, ~school_lon, ~school_lat, label = ~school_name, icon = school_icon) %>%
    addProviderTiles("CartoDB.Positron") %>%
    setView(marker_schools_search$school_lon, marker_schools_search$school_lat, zoom = 13)
  
}

get_hs_from_mid_map("14K449", 2009)


## saving main middle school data frame
save(hs_to_mid_edit, file = "/data/nycdoe/clean_data/data_for_highschool_from_middle_school_feeder_map.Rdata")

```


